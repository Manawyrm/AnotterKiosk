#!/bin/sh

display_splash() {
    # Disable the VT consoles
    if [ -f /sys/class/vtconsole/vtcon0/bind ]; then
        echo 0 > /sys/class/vtconsole/vtcon0/bind
    fi
    if [ -f /sys/class/vtconsole/vtcon1/bind ]; then
        echo 0 > /sys/class/vtconsole/vtcon1/bind
    fi

    echo | /usr/bin/fbi -d /dev/fb0 --noverbose --nointeractive -T 1 -1 -t 0 -a /boot/firmware/splash.png 2> /dev/null > /dev/null
}

# If there's already a /dev/fb0 (like simple-framebuffer or a UEFI framebuffer on x86), use it
if [ -e /dev/fb0 ]; then
    display_splash
fi

# Try to load Raspberry Pi GPU/DRM drivers now, otherwise the driver load will wipe the splash later.
/sbin/modprobe -abq vc4 drm_display_helper cec v4l2_mem2mem drm_dma_helper videobuf2_dma_contig videobuf2_memops videobuf2_v4l2 v3d videodev gpu_sched i2c_brcmstb drm_shmem_helper videobuf2_common drm_kms_helper mc drm  drm_panel_orientation_quirks backlight

until [ -e /dev/fb0 ]
do
     sleep 0.2
done

display_splash